v1.7.5
## 2015-1-13 21:48:37
1.修复TPA系统BUG，增加TPA屏蔽模式.
2.语法上细节优化，增加自动检测IP实现自动登录系统.


## **2018.7.18**
修改PRACE完成结束为20秒，10秒倒计时提醒。
修复小世界无法说法BUG
进入赛道自动设置小世界，离开自动退出
修改速度表为玩家计时，非空表转，节约带宽，理论支持TV模式下看对方玩家的车速..

（以上可能均有BUG，等待测试与修复）

## 2018.7.20
优化部分代码逻辑结构
理论支持赛道实时显示对局房间排名
玩家颜色为随机，并非以前固定

（以上可能均有BUG，等待测试与修复）

## 2018.7.27
修复赛道实时排名异常
修改赛道计时时间为10ms，更动态显示毫秒
修复赛道第一个点自杀重生回到0,0,0坐标问题
修复大部分赛道倒计时问题（还有一点小问题）
修复诸多BUG

## 2018.7.29
修复 诸多BUG
修改 新样式速度表

## 2018.7.30
数据库加密！数据库加密！之前版本请千万不要泄露

---
> 中间停更了好久……很多更新日志都没写了 趁着疫情写写完免费开源
> 

## 2020.1.6
**重启RST车队官方服务器**并**增加Linux服务端**
格式化代码
优化一丁丁的return及简化部分代码

## 2020.1.12
**修复 由timerfix插件引起的计时器随机性概率被杀**

1. 修复 玩家下线后未清理干净infobj
2. 修复 /soundstop未停止
3. 修复 在重生时离开赛道导致屏幕一直显示“重生中”字样
4. 修复 赛道CP点重生后车辆的朝向角度不是CP点的朝向角度
5. 修改 速度表红色底色
6. 修改 速度表的时间频率为100毫秒
7. 修改 刷车的相关代码
8. 增加 赛车系统时**允许pm聊天**
9. 增加 赛车时**离开载具自动复位**
10. ***尝试性修复*** 单人赛道房间浪费资源运算实时排名
11. ***尝试性修复*** TV玩家时速度表不显示或显示错误
12. ***尝试性增加*** 赛车世界至1000个
13. ***尝试性修复*** TV玩家下车上车响应动态跟踪TV

> 第一名碰到点后触发的倒计时的KillTimer排名可能还存在问题 需要重做倒计时系统

已知问题:
- ~~单人赛道房间也会浪费资源运算实时排名~~
- ~~双人或多人在完成比赛或未完成比赛时触发倒计时的时候的神奇BUG（不离开小世界，CP点重样，屏幕字没清理干净，没回到大世界等~~
- 第一名碰到点后触发的倒计时的一系列BUG
- ~~密码输入错误应该是3次机会但是还是有4次机会~~
- ~~由于总人数更新，赛车世界需要再增500个（共1000个)~~
- 在副驾驶进入赛道导致没有车辆
- ~~kgobj好像没卵用~~

提交BUG请在群里反馈

已知意见：

- 刷车效率提升
- 赛道重生增加C键或F键或下车自动重生
- 增加家具、PHouse系统
- help重做
- 增加动作系统

## 2020.1.13

1. 刷车效率提升
2. 赛道中下车自动死亡重生
3. 重做/dcar和Repair的相关判定
4. 尝试密码共3次机会
5. TV中对方切换小世界响应观看者自动进入并观看
6. 想观看的对象正处观看他人时则提醒对方已进入TV状态
7. 服务器动态名字

#### 已知问题

- ~~默认就是车辆无敌，进入游戏后首次输入dcar仍然提示开启车辆无敌（需重做）~~
- 部分用户因刷车效率提升蹦游戏，后期需要调刷车延迟稍微大一点点
- ~~处于编辑状态中的赛道仍可进入~~



#### 赛道计划

- 把有的赛道的数据库迁移进PRace（难度挺大），正在处理中
- 反作弊二次升级（判断CP两点间距离和玩家如果上一秒距离下一个点很远，但下一秒就贴到脸上（没吃到点的那种，则判定作弊）
- ~~打算今后用日期命名pwn~~
- 把/r s单页的显示赛道数量调多一点？



####  已知意见

**继承2020.1.12的所有**

- 增加管理员重置密码选项，当管理员为该用户设置后，且改用户在线上，那么就可以直接重新生成密码，保留其他的数据





## 2020.1.14

正在尝试把7F数据库都搬过来哦

已知BUG

- ~~有可能终点的CP点消不掉~~
- CP点倒是消了，结果**倒计时没了**，还多了个房主离开房间的时候其他玩家的CP点没清掉

修复

- 赛道被编辑状态却还能加入的状态
- TV谁都一直是正在TV的状态
- ~~现在完成赛道后也显示多少秒了，不用再去换算啦~~
- 又尝试修复了一遍登录前会显示其他人的赛道状态的问题？？？
- 赛道数据库迁移了所以上限和每页显示的数量提升了
- 然后有时候赛道的时候切出去太久回来车直接没了…… 这个理论上现在修复了





## 2020.1.15

- **导入成功7F的赛道数据库，对照所有服来讲为数不少的百条赛车数据库建立√**
- **增强反作弊，避免红点传送误杀（增加了距离判断**，理论上以后还会更新更强的，也就是每秒判断玩家距离到下一个CP点距离且下一个CP点的高级函数没有传送就判定作弊）
- ~~作弊被封的时候KickEx能够让玩家知道自己被封多久了，不必每次上线再看~~
- ~~被封了还能直接上号~~

已知问题

倒计时 房主进了之后剩下的人直接退赛道

~~tv off速度表好像还是没清掉 不过已经改了或许修复了~~

赛道倒计时一如既往神奇的BUG（如果只有自己一个人结果还是会触发倒计时的问题 还有多个人的话就不显示倒计时的问题）

赛道rid 107~132的CP点出现严重BUG

~~赛道中重生导致无限死亡~~

~~重生状态下离开不会回到大世界（现在大概已经修复了吧~~





补充：删除赛道的话，要3个表都去走，以rid为准，DELETE WHERE RID=那个赛道，不然会删不干净



如果部分赛道名字和赛道没对上请联系反馈手动维修



## 2020.1.17

- 理论修复了比赛完成后倒计时的BUG

想要增加到终点后如果还存在其他玩家则自动观战，增加战局的详细信息统计如玩家的平均速度

然后重生到开比赛的地方？

用rgamecp判断玩家是否已经开了比赛 一般在的话就是真 也就是>=1

然后tv 但是所有自动切换tv的地方都得改改咯

showtextdraw  cptextdraw time top 还有那个 Race_ShowCp展示玩家的地图点





## 2020.2.4

- 新增 15秒增加一次氮气（原先氮气算法）
- 随机出生点及播放音乐
- 系统传送点在大世界将显示3D文字
- 尝试修复/r page页数错误的问题
- 增加动作脚本/anim
- 优化登录界面加载顺序
- 尝试修复速度表丢km/h的情况



## 2020.2.5

- 尝试增加观战时显示玩家的CP点，时间，排名
- 修改部分样式
- 尝试增加多人房间某玩家完成比赛后自动TV剩余的玩家
- 修复unfinished win finish显示
- 修复在车上换皮肤导致的显示错误
- 修复TV状态下死亡无效以及显示异常
- 修复玩家吃CP点的时候观战玩家无提示音
- 尝试修复玩家观战时在没吃点前不显示CP点
- 尝试性修复锁了车没效果
- 尝试性增加进入车辆提示是否为本人车辆
- 增加碰碰车/ppc



## 2020.2.6

- 以前的OBJ和传送点的3D文字改用流光插件函数

- infobj改为流光的函数

- kgobj修改

- 加入hys车辆自动变色

- 流光渲染OBJ渲染距离修改为500 原来为300[好像没什么卵用]

- 优化主地图的for到maxplayer的算法改为for (*new* i = GetPlayerPoolSize(); i >= 0; i--) {

  > GetPlayerPoolSize服务器上当前正在使用的最高玩家编号；如果没有玩家，则返还**0**



下一步打算把MapIcon用流光插件做赛车的普通检查点，显示按某个键发起该比赛，然后弹出对话框加入。



## 2020.2.7

- 重做/help和/sz
- 修复验证时间不更新的问题
- 修改判定锁车后上车的BUG
- 天气限制为0~255
- 游戏时长< 120分钟登录后自动弹出/help
- /time  格式修改为 /time 时 分
- 修改读取数据库的部分结果 和以往版本不能混用
- 尝试修复家具并融合gamemode
- 修复刷武器时不选武器也会刷的BUG
- 增加PHouse并适配金钱至RST用户数据库的Cash



## 2020.2.8

- 自2020.2.7版本起，大部分文件都修改了路径
- 修复了vmake未同步修改路径的错误
- 改回kgobj
- 赛道排名改为1st,2nd,3rd,4th,5th,6th
- 修复按Y呼不出家具
- 尝试修复PHouseedit并修改了指令
- 修改了部分公告
- 修复管理员帮助无效
- 修复设置界面的OBJ显示反了



已知问题 /sz的时间一直处于12点 GetPlayerTime函数不知道出了什么鬼问题，代码是绝对没问题的

已知问题 无法绑定邮箱以及找回密码【目前没开PHP】



## 2020.2.9

- 修复gogoods永远ID0
- 修复自动修车及换颜色会被副驾驶影响
- 修复giveadmin和unadmin失效的问题
- 尝试修复终点的CP点不计算排名的问题
- 尝试修复因Race_Game_Quit一处代码导致的倒计时失效的问题
- 修复/sz设置时间和天气时点取消仍然设置
- 修复点击出生时的notice时概率性出现多次SCM的情况
- ~~创建CP点时将检测玩家将创建的点与上一个点的距离是否过近，如过近则不允许创建~~
- /r /r edit适配help里的dialog
- 修复因指令过快导致r edit d 不弹出界面
- 修复按键导致断氮气
- 游戏时间不足30分钟，不可创建赛道
- 修复房产没对上号的问题
- 修复玩家掉线后未正确处理tvid导致速度表异常
- 修复CP点有可能没删干净的问题
- Phouse的按键C改到按键Y
- 修复刷车后偶然出现没氮气的情况
- 修复刷车导致视角丢失
- 修复完赛后观战，玩家冲线后CP点不清



## 2020.2.10

- 修复按Y家具失效
- PHouse总OBJ上限调至10W，总文档上限调至1000
- 家具修改管理员等级
- TAB点击玩家现在支持显示管理员等级了
- PHouse stock函数适配playerid提示 ☆
- 取消显示*对方当前未在赛道中，是否继续观看？* 直接退出tv 再显示结算对话框
- 结算比赛将获得金币，可用于购买房子
- 大世界将显示所有赛道的发起点 即第一个CP点
- 修复距离过远显示文字
- 增加了一些单机有的MapIcon
- 取消原来的textdraw notice改为对话框形式
- Houseedit适配SCM
- 修复部分房产冲突
- 尝试修复gogoods id有问题 delgoods因原作者语句顺序问题导致OBJID显示异常
- 修复delgoods不能删除id0

## 2020.2.11 

- 房产在地图上将根据出售和已售自动生成地图图标
- 修复观战时吃CP点没声音
- 增加脚本免重启添加OBJ
- 我的设置的天气增加天气提醒
- 修改个人信息DIALOG样式



## 2020.2.14

- 新增车辆翻车后自动翻转设置 已默认开启 /sz可关闭
- 已知问题 编辑赛道的设置CP点以及测试该赛道失效 因PRace版本的锅
- 将来将会加入cveh高级函数 即在赛道中换车（别忘了PlayerInfo playerid [Buyid] = 刷出来的车 这样和赛道重生才能匹配上）

- 赛车反作弊即将升级，将有利于判断是否为过于异常数据刷赛道













算法 玩家上一个CP点不是高级CP点 且  玩家z轴和上一次z轴相差< 10或更低的值 ~~且 这一秒车速 > 上一秒车速~~ 且 跟上一秒相比 > 某个界限值  则直接封号1小时



原理 高级CP点可能会有函数设置车辆速度 所以会误封 所以要判断是否是高级CP点触发

如果不是则判断玩家的高度是否改变，正常车辆正常行驶在高度相差不是很大的时候，是无法让速度在短时间内突然变高很多，除非下坠的时候。

所以要求出两次z轴绝对值相比是否大于玩家下坠的每秒z轴 这个要测过的，然后如果是的话再检测 

上一秒的车速减去这一秒的车速 （不用绝对值） 如果相差值在某个界限则可判定



这个可以防微加速和暴力数据

至于只是改了车辆最大值的数据的话

还可以加一句Getspeed是否大于某个车速

因为有z轴高度差的加持，我相信不会很容易误封



~~还得加一个判断上一秒的玩家CP点和这一秒的玩家CP点相同 不然如果吃了一个CP点的话就会误判~~



不对不对 可以直接判断玩家当前的CP数是不是高级CP点 如果不是就...同上



判断的语句顺序应该很重要 这样可以减少db的访问

第一层是判断玩家是否在赛道中

第二层是z轴和速度的判断

第三层是判断CP点是否为高级点

不然的话一直访问db 非常消耗算力





## 2020.2.15

赛道反作弊升级  + 2判断

部分include stock的参数已改为const 参数

增加问答

增加7F NPC

修改问答为5分钟一次

已知问题 问答显示不全





## 2020.2.18

- 修复问答显示不全
- PRace新增cveh和weather函数并适配gamemode
- 修复玩家未登录时TAB访问信息不返回的问题
- 修复PRace 编辑赛道时从这个点测试和修改CP大小没反应的问题
- 重新适配官方正版mkstr的inc
- 新增并修复mta2赛道aroundtheworld - 我想环游整片星空，找到你的星球部分OBJ掉线的问题
- 修复对方未登录却仍能观看的BUG
- 修改问答颜色





## 2020.2.20

- 修复部分已知问题
- 修复被封杀后重新登录不弹出剩余时间的BUG
- 增强某些作弊的判断机制



## 2020.2.21

- 加入fakekill~~和car troll的检测~~
- 修改部分检测机制
- 现在被封禁后将显示封禁代码



## 2020.2.22

- 创建比赛后如果是房主将提示/r s开始比赛
- 增加某反作弊功能



## 2020.2.23

- 增加pizza MTA经典赛道
- 玩家重生时将先删除车辆再重生，避免code2反作弊误封
- 房屋系统将只显示在大世界
- 尝试修复重启服务器导致NPC异常
- 创建赛道时间改至60时间分才可创建
- 创建赛道改至一次-3000游戏金币
- 重新修改赛道重生
- 修复玩家观战，某玩家跑完赛道导致关闭tv的BUG
- 现在下车不再直接杀死玩家了，而是提示是否确定重生



## 2020.2.24

- 房子单个人上限买4套
- 可通过/house list查看有哪些房子及情况了
- 修复代码10误封



## 2020.2.27

- 修复买房上限因某些原因失效
- 可能修复设置车牌号失效的问题
- 反作弊由1小时改至10分钟
- 车辆换色适配老玩家习惯的/c color
- 修复giveadmin出错的BUG

## 2020.2.29

- 更改密码处适配散列技术
- 未绑定邮箱也可以修改密码了
- Phouse增加支持纹理和Area了
- 理论上修复想上NPC车的一瞬间NPC切了地方就会被误封代码3
- 开始抢救乱码问题 预计1天
- 修复修改车牌Z轴方向和没氮气问题
- 已有代码已转向izcmd
- 增加装扮

## 2020.3.1

- 增加大量怀旧问答，问答由4分钟改为2分钟一问，每下一问将回顾上一问的答案
- 已知~~pm失效~~ 现在pm成发电报了 再编译一次就好了 已经修改了
- 增加几种常见装扮
- 问答将按随机顺序
- 增加屏蔽词
- 即将支持DM 公告牌

## 2020.3.2

- 可能修复了问答出现0?的问题

- 增加了广告牌系统

- 冗余了部分屏蔽词，屏蔽词达2700+

- 设置中增加了我的家具，便于传送和编辑

- 设置中增加了我的装扮帮助

- 修复我的时间失效问题

- 修复家具传送第一行的错误

- 修复广告牌删除后仍能传送和编辑

- 尝试修复某些不知道什么贵原因导致玩家Salt后边跟了个日期

- ## 修复赛车中能用指令的BUG

## 2020.3.3

- 尝试修复广告牌字符过长导致的崩服
- 新增爱车
- 修复赛车中仍能输入指令的bug
- 修复爱车出售玩家不在线拿不到钱的BUG
- 修复爱车出售刷屏刷钱的BUG
- 修复爱车出售逻辑上的问题和拿不到钱的问题
- 即将支持 爱车出售给系统 接近原价的回收

## 2020.3.4

- 理论修复无法买系统车，玩家能买未在出售的车的BUG
- 理论修复创建爱车的时候没任何提示，没3D文字的BUG



## 2020.3.5

- 尝试修复爱车3D文字错乱问题

- 爱车3D文字将支持流光插件

- 尝试解决code 10数据异常 修改了算法

- 理论上修复了爱车不能保存的问题

- 修复问答消失的问题

  

## 2020.3.6

- 即将支持上爱车提示是否购买，弹窗dialog，不购买则扔下车
- 支持ac或cars命令共用，新增cars wode,召唤爱车直接讲玩家放进车里.
- 即将支持 倒计时只在某个玩家指定范围内显示
- 即将支持 换号（update insert delete这样子 UID终身不变）



## 2020.3.7

- 支持上爱车提示是否购买的对话框
- 新增判断爱车上锁后被CLEO劫车将复原
- 修复爱车重生后没有颜色的问题
- 倒计时变更为范围倒计时
- 玩家颜色可在/sz免费修改了
- 聊天细节优化
- 新用户注册将检测是否为合法名字
- 即将支持更换用户名



## 2020.3.8

支持修改用户名





更换用户名 只要update名字就好uid永久不变

只要检测名字是否带{}，是否为中文字，是否带屏蔽词,是否有同名的玩家，是否为特殊字符或空白字符。



已知问题: 广告牌可能在未知条件触发下造成按Y没任何反应

已知问题 赛车删除赛道后3D文字和地图图标还在





## 2020.3.12

PRace将自动根据赛道名升序显示赛道，创建赛道，删除赛道自动同步重新排序

赛道删除后3d文字 图标 地图CP点将同步删除

理论修复ac list显示不全的问题



## 2020.3.14

团队系统初步框架构造



## 2020.3.15

团队系统基本功能实现

加V认证

团队适配反瞬移get

管理员get适配反瞬移

16年和范冬梅一起写的camera适配



## 2020.3.16

增加DM





## 2020.3.17

管理员的get和goto将支持载具同步

团队新增get和goto指令/t get /t goto

尝试修复因为重生导致被反瞬移作弊11误封

尝试修复无敌时间中删不干净

增加团队频道#

修复goto写反

修复团队频道返回值错误问题





## 2020.3.21

修复装扮沙鹰导致的乱码等问题

移除玩家无敌中状态的3D文字

修复部分代码引起的11反作弊误封



## 2020.3.23

加入爱车禁止进入比赛和编辑赛道的提示

修复跨团队操作成员的严重BUG



已知问题 Carspam反作弊未知抽风   可忽略不修或干脆移除



## 2020.3.24

修复因内存栈问题导致的团队成员失效和服务器崩溃

移除Carspam

即将进行 字符串长度等全局变量代码适当优化

问答将取消大小写限制

尝试修复无团队下仍显示团队的问题

广告牌将显示名字和UID

尽量减少碰碰车特殊载具

我的设置新增屏蔽碰撞并自动适配赛道系统和碰碰车系统

家具将支持透过大OBJ显示3D文字了

家具3D文字距离从20改为10

修复name on off隐藏显示异常

修复stunt on off无提示



## 2020.3.25

家具和公告牌过近时，公告牌为最高优先级，而不再是执行了公告牌的瞬间又去执行家具导致卡在公告牌编辑的状态下。

公告牌的3D文字将下移一点



## 2020.3.26

DM玩家攻击后将显示对方的一系列信息

已知问题 DM在linux环境下无法读取到地图

完成赛道后显示finished位置将改变

高级CP点反作弊增加函数判断

赛道第一个CP高度位置过高时同步了object loading提示





## 2020.3.27

未来计划

简单的循环一次延时摄影 ×

赛道支持人物行走并写出新的人物反作弊 √

小世界私人世界完善 √

linux下DM 地图问题BUG修复  √ 

DM增加护甲 √

DM不读取玩家装扮避免公平性 √

DM支持PM √

回答问题写在后面 √

修复结算排名显示文字错误 √

**PS linux下的路径和文件名不可出现中文等字符！**



已知问题 DM的FPS获取频率问题

懒得搞了反正基本上是对的





## 2020.3.29

修复一严重级BUG 某些情况下导致重复注册问题

管理员可通过reset重置用户密码

速度表增加开关选项

减缓进入游戏时的视角速度

团队邀请功能正式使用

支持：

系统传送点列表 /telemenu

管理员创建系统传送点smake

修复团队成员跨权操作管理员



## 2020.3.31

进入时的上下黑边有缝隙的问题可能解决了

修复解散团队后仍显示在团队

修复邀请玩家加入团队不显示

修复玩家无法加入团队的问题

尝试修复我的家具无效

增加 - 流动广告牌

NPC加载延迟1000毫秒1个避免linux上总是加载失败

DM尝试适配移速反作弊

最好是在4月中旬前开源





## 2020.4.1

修复团队列表显示不全的问题

修复装扮显示页数限制5页等问题

尝试修复DM中最后一个死亡因触发spawnplayer导致fakekill误封

NPC将延迟至3秒添加一个防止加不进来的问题

DM加入一个几年前的防自瞄

大世界不允许使用某些武器

DM加入反刷武器的反作弊

修复乘客在赛道中显示数据异常的问题



## 2020.4.2

优化CRF代码结构

加入timerfix的include和samp服务器自身的BUG修复fixes的inc



已知问题过快的反复kill在DM里会误封





## 2020.4.3

赛道挂机时间判断延长至45秒

降低11误封率



**-------未来计划-------**

增加延时摄影合并在camera（第一个镜头和最后一个镜头设置的时间才有效）然后留一个单独的指令

尝试增加世界时间

尝试将7F的动作脚本合并

修复fakekill7在DM下的问题

修复DM下移速可能不被检测的问题



未来计划

~~小尾巴（个性签名） 称号~~ 烟花（找开源）~~~DM懒得弄~~~  

- 代码全部转向i-ZCMD(zcmd优化版) √
- 可通过cmd_之前定义的CMD调用 √
- 配合sscanf2（2020.2.27更新了本地plugins和inc) 部分代码√
- 未来计划参照上面的 然后加一个report.db 玩家反馈的数据都在里面，然后状态模仿MIUI11提议 - 立案/不立 - 开发 - 结果 (太懒了不想写)
- 加一个SAMP原版自带的大楼电梯脚本 √

增加

- 基础的DM √
- 增加反锁血 fakekill可能算吧 √ 
- 刷夜视仪刷枪的反作弊  这个懒的写了
- 公告牌系统，并且判断是否带敏感词汇（聊天也要加）([Anti Swear](https://forum.sa-mp.com/showthread.php?t=324706)) 自动变成* https://forum.sa-mp.com/showthread.php?t=596260 √
- 装扮系统 √
- 团队(帮派)系统 √
- 家具购买菜单，需要拥有大量OBJID，不然很难实现
- 登录界面显示上一次登录时间，需要更新数据库格式了. √
- ~~当玩家挂机时，玩家镜头随机移动或通过camera editor创几个点（论坛有这个脚本）,检测玩家是否挂机在自由者4里有~~  改用16年范冬梅帮忙一起写的视角工具 √
- 取消原有机制，未设置邮箱保护将可以更改密码 √，~~更改密码将修改为二次验证，即输入两次将在安全设置内增加更换用户名，也就是换用户名但不能够更换到已经注册的用户名，并验证密码，然后踢下线。 **(还差个更换用户名) **~~ 免重新上线的更换用户名已写成功! √
- 把SAMP自带的删除的建筑物的官方脚本里填充的加上 ls_elevator ls_beachside ls_apartments适配流光√



## 2020.7.6

> *可能是整个SAMP圈子首个支持windows和**linux**双系统下**unicode**的正则匹配昵称插件*

**对于本次插件更新是基于ASAN插件进行修改,暂不打算开源插件源码.**

比mk124前辈的NPatcher功能更加强大，可控制更多对于昵称的限制。

例如同名玩家可以同时进入服务器，精准控制可使用哪些范围的昵称。

本次更新服务器将在linux下默认正则匹配汉字、【】、丶、英文常见符号、英文、数字、下划线



修正

TextDraw为PlayerTextDraw,以规避samp的limits导致的异常问题

增加

玩家设置中的常用开关项可支持保存了

现在金钱操作时会保存数据库（过去是下线时触发）

网络参数显示

TAB栏信息优化

已知

之前的注册用户Salt后面又出现时间了,正在努力查找引起BUG的原因(近期将整改数据库列名).



## 2020.7.7-7.8

我的设置常用开关移植到设置中的个性化设置中

个性化设置中现在加入了玩家名称开关和特效奖励开关

相机系统现在可以直接以相机视角而非通过玩家位置进行定位了

修正

帮助系统和设置系统中对话框有时返回错误的问题



## 2020.7.10

增加

​	3D速度表/c 3d

修复

​	个性化设置返回问题

​	可能修复NPC断氮气问题

​	出现丢包但颜色不变的问题

删除

​	NPC出生时的SetSpawnInfo可能引起未知的问题?

---

## 2020.7.13

修改

​	用户注册的Salt范围

​	自带npc加载间隔(3000ms>>100ms)

修复

​	个性化设置返回问题





## 2020.7.14

增加

​	赛道发起页增加赛道创建日期

​	赛道发起页的时间增加分秒毫秒

​	PRace个人记录系统

​	等级系统（经验）测试版

​	TAB栏显示等级 对应名称 和 最近100场记录

​	登陆超时系统

改进

​	PRace全适配easydialog

​	爱车全适配easydialog

​	Camera全适配easydialog

​	统一爱车颜色变量名为Color_ACColor

​	修改获取页数为GetMaxPage全局可调用

​	取消了Camera_GetMaxPage()

​	定义function为forward public

​	取消main的内容,更改至gamemodeinit下

​	gamemodeexit下加强了服务端关闭可能性造成用户没保存的问题

​	获取比赛次数采用count而不再通过rows

​	升级后将SCM提示

​	修复适配easydialog造成的登录错误重试失效的问题

​	重置所有kickex为DelayedKick



## 2020.7.15-17

改进

​	DM全适配easydialog

​	团队全适配easydialog

​	npc全适配easydialog

​	PHouse全适配easydialog

​	PHouse取消重复定义的GetPages函数，改为GetMaxPage

​	广告牌全适配easydialog

​	Attire全适配easydialog

​	PlayerInfo尽可能适配easydialog 不确定稳定性

计划：全局EasyDialog + 数据库注册日期和登录日期改用时间戳



## 2020.7.19

修复

​	速度表无法显示其他玩家

​	优化速度表显示逻辑结构

增加

​	团队成员中显示团队成员在线状态



已知BUG

/selectnpc失效 <!--完赛经验显示异常--> 观战显速度表不显示速度 比赛信息不显示（是因为PlayerText:类型只能给创建给的玩家显示，不能给其他玩家显示，但不应该说去改为Text:，而是让其他玩家为了显示的时候，把自己的数据修改为对方的，而不是说隐藏自己的再去显示对面的这么个思路）



TextDraw使用INVALID_TEXT_DRAW初始化

如果是数组{*Text:*INVALID_TEXT_DRAW,...}

不是数组*Text:*INVALID_TEXT_DRAW

玩家数组{*PlayerText:*INVALID_TEXT_DRAW,...}

不是数组同理



但是用了这个的话 AMX体积会很大……



## 2020.7.20

**正式启动计划DB转全局MYSQLR41并高度依赖UID**



已尝试适配Goods_Sys,暂不知是否有问题

优化邮箱验证部分代码和数组大小

修改我的物品mygoods



优化AccountCheck函数效率

即将重写所有users部分包括AccountCheck





已知问题

过去的salt根据随机数指定的ASII码会生成sql特殊字符` 导致注册用户异常或读取数据异常或密码错误

至于之前出现的房子相同的问题可能是因为之前的数据库没开unique用户名把……





## 2020.7.21

**彻底废除原有的user.db表**

理论上彻底根绝**莫名其妙密码错误**和同**用户名多用户保存错误**的问题

**当本地无数据表但有数据库时，自动生成用户空表**（以后拿开源想架服的必须得有MYSQL服务，并重新编译服务器MYSQL用户，密码，数据表） 注意安全请自行分配用户和权限，本地和远程权限等。

**重写用户表**，**所有用户密码被重置为123456**

**用户表已适配MYSQLR41**

**注册日期，最后一次在线日期修改为timestamp格式**

**ongamemodeexit智能适配保存玩家信息，防止直接关闭（除杀进程之外的崩溃）造成的数据不保存**

**登录超时改为1分30秒，等未来适配邮箱系统时，将更改为10分钟**

**并将同时允许多用户同用户名登录[意味着可以挤号了而不是同名进不来(基于ASAN - RST团队修改版)]**

增加信誉分系统(试运行,全自动化处理)

调整玩家经验

---

~~**已知问题:时间戳转格式不准确**~~

~~已知问题 邮箱验证系统可能造成用户出生异常，但可游玩，不建议赛道重生等~~

~~已知问题 **重置密码可能导致无法登录（密码错误）**~~

~~已知问题 广告牌不显示名字~~

~~已知问题 出生异常导致如果狗带会被反作弊误判代码7~~

## 2020.7.22

修复

​	重置密码变量错误导致重置错误的问题

​	TAB栏点击玩家等级显示错误问题

​	NPC断氮气问题

~~已知问题 信誉分可能超过100（负数算法问题）~~



## 2020.7.23

速度表更新频率→200ms

修正比赛排名计时器没初始化和赛车房间删除错误初始化问题

优化比赛计时器

- 过去的计时器是每个玩家都单独进行计时，那么一个房间如果6个人就相当于6个计时器
  - 并且因为是超低的频率10ms，所以一秒钟的递归/运算就达到了6 * 100次 = 600次
  - 这一次参照房间排名的计算，为单独的房间开计时器，那么再多人他都是一秒钟递归/运算100次



玩家textdraw可以在销毁后改为invaild_...可能比直接在变量初始的地方赋值会好很多（避免直接体积大小太夸张）



## 2020.7.24

团队适配MYSQLR41

修改团队成员列表返回逻辑

修改团队列表返回逻辑

TAB栏中的玩家点击团队支持快速跳转至我的团队

其他人点击该玩家则显示邀请加入



## 2020.7.25

爱车适配MYSQLR41



## 2020.7.26

PRace适配MYSQL41中



已知问题

PRace加载赛道只能加载一条



## 2020.7.27

PRace适配MYSQL41

广告牌适配MYSQLR41

装扮适配MYSQLR41

修复PRace加载赛道只能加载一条

重写tpa

TAB栏现在可以快速请求TPA传送了

> PS:以后开源还是挺要技术活的嘛，不然本地都开不起来哦~ 最起码得懂架MYSQL服务
>
> 最好是还会NodeJS服务,用linux平台,还得学会升级gcc,软链接标准库等

**尝试修复**

(理论上**修复**了**历史遗留问题**)

​	**Linux下NPC不触发onplayerspawn问题**

​	浏览爱车错误问题

​	**爱车**上车错误问题（已上锁、无法召唤等）

​	召唤爱车成NPC车问题

>  造成原因pACEdit[playerid]是CarInfo的第几个的i下标而不是车辆ID(vehicleid)
>
> 误把pACEdit[playerid]当vehid才会造成问题
>
> CarInfo [ pACEdit[playerid] ] [GotoID] 才是对应的vid
>
> 

已知问题

PHouse适配难度略大，修改思路→MYSQLR41(√)→修改表结构（按照一个文档一个表改为所有文档都在一个表，根据文档ID去确定哪个txt文档里的文件都对应于哪个文档ID  也就是 把drop `%i`改为 delete 文档总表 where 文档ID = 那个文档 创建表也是改为insert into 总表 哪个文档ID... 读取也是 from 总表 where .... and 文档ID =   最最最烦的就是PHouse里面的这几个部分了，还有创建事务部分）

~~Linux下NPC不上车，但在Windows下正常(**长期问题**)~~

## 2020.7.30

PHouse适配难度较大，暂时就处于sqlite阶段好了，后续再慢慢适配R41

PHouse db变量名改为pHouseData

引入NodeJS sampmailjs (慢慢开发邮箱绑定等安全操作)

修复更换密码可以为不受长度限制的BUG



已知问题

找回密码绑了邮箱的话显示异常并且再点一次就提示不要频繁设置

安全中心验证次数过多连进都进不去



## 2020.7.31

尝试适配sampemail

增加登录时找回密码

摒弃最初的邮箱系统写法

基本重写

修改yz表结构默认值为'0'



已知问题

用户注册后需要重新登录才能正常在TAB栏个人信息处显示UID和注册日期



这里讲讲MYSQL的好处

相较于本地化的sqlite，**mysql效率更高**，并且可以用**线程、多线程**跑，**并且可以更好分配权限**, 防止远程操作删库跑路等，而sqlite只能在samp主线程里,如果慢的话就会服务器未响应般的就跟突然丢包100%一样，数据不传输了，会对玩家操作进行影响

另外**sqlite对中文**的支持不好

用mysql还有一个好处是,可以多个服务器用同一个数据库,实现**多服数据互通,**有钱的话还可以开多地，然后数据库汇总在一个总服务器上就行（我是这么想的，应该是没啥问题的）。然后**再跑个自动备份**的，就会比较安全了，数据大不了云端再备份，也**方便迁移**的



**nodejs优点相比php**

过去的邮箱验证采用php,并且需要在php上调用MYSQL接口

现在的nodejs采用游戏内变量即可生成验证码

并且nodejs部署比php简单

不需要装wampserver(win)或者是apache(linux)

也不需要在linux上很折腾

安装完nodejs后也就一句npm install

撑死去改一下config.json里的账户密码

然后重新编译下sampemail.inc 账号密码和服务端IP端口就行

一句node sampemail.js就开起来了，并且是秒启动

试过就知道多轻量级了

并且nodejs的这个sampemail可以支持自定义模板并可替换部分标签

发送不同邮件也都可以指定不同的用户名 主题 网页

---



## 2020.8.1

家具系统Owner值改为UID

是否销售的值改为0 1

修改家具系统表结构

邮箱设置时检查是否已经被使用

user_goods改为utf8表

user_goods引擎修改为innodb

修复用户注册后需要重新登录才能正常在TAB栏个人信息处显示UID和注册日期

创建比赛textdraw信息和修改全都统一到函数中

保护赛道机制 - 90天前的赛道将只能由管理员删除

尝试适配PRace TextDraw观战显示



## 2020.8.2

修复

​	同IP在线被T出服务器不提示信息

​	广告牌列表页数不准确问题

​	退出赛道时提示错误

​	理论上修复创建比赛等提示指令错误问题

​	适配更换用户名 - 保存赛道、家具名称

修改

​	PRace的部分写法（同房间内玩家循环），提高效率

​	msg, 128 全部改为msg, sizeof(msg) 规范化

​	PRace TextDraw改回英文

​	*Race_Cp_Script_Function_* > RaceCpScript_func_

保护赛道机制 - 180天前创建的赛道的记录将只能由管理员清空

**适配PRace TextDraw**

增加赛道信息/r info指令

**赛道重生已增加spawnpos**，支持指定位置重生（仅支持一条，如添加多条spawnpos只采用优先级顺序第一条）

数据库

​	**PRace中的作者列改为UID并且进行数据迁移工作（之前赛道的作者没注册过的用户自动注册）**

​	**重做PRace主库，删除并重写原有的排行榜字段。**

​	**全部统一至个人记录表，旧排行榜已全部转移。**

​	**未创建的PRace用户已默认注册账号，但无法登录(密码错误，需联系管理员重置)**

	INSERT INTO users(
	`Name` ,
	`Password` ,
	`Salt` ) 
	SELECT DISTINCT `rauthor` ,
	     'null' ,
	     'null' 
	    FROM `race` WHERE NOT EXISTS(
	    SELECT `Name` FROM users WHERE `Name` = `rauthor`
	);
```
更新列值为UID
update race set race.rauthor =  (select users.id from users where race.rauthor = users.name) where
exists (SELECT 1 from users where race.rauthor = users.name);
```

赛道的话最好是支持无限扩展人数 那么就得废除原先的PRace排行榜写法 √

top榜通过个人记录表去获取 加个LIMIT 和 ASC记录就可以了 √

那么最大的问题就是之前的一些记录只能人工转移了 √

创建没创建过的那些人的账号 √

然后PRace的Name也得去适配UID，废弃掉, 然后用~~外键~~啊啥的 √



**对吧 想像一下记录全都由个人记录表接管，查询排行榜和最近比赛的指定条数也很方便，封号了直接删那个人的赛车记录也很简单，不用去抹原来的排行榜那种写法，最大的问题在于数据迁移。**



已知问题

​	~~不显示检查点CP~~

​	~~玩家切换观战不销毁赛车信息~~

​	~~被观战玩家离开 观战玩家不销毁赛车信息~~

​	~~需要增加比赛倒计时给观战者看~~

​	刚观战时不显示玩家的地图CP点

​	~~textdraw信息不更新~~

​	~~无法加入比赛~~



如果有耐心的话倒是可以去做个跑跑卡丁车那样子的动态排名有哪些人和对应的网络状况这样子

结算界面也可以参考



**CP触发点是能单一删除的 输入删除就行了**





## 2020.8.3

- 需要加一个指令重置玩家邮箱

- 增加GPS导航系统（地图定位后开启）



PHouse适配难度略大，修改思路→MYSQLR41(√进行中)→修改表结构（按照一个文档一个表改为所有文档都在一个表，根据文档ID去确定哪个txt文档里的文件都对应于哪个文档ID  也就是 把drop `%i`改为 delete 文档总表 where 文档ID = 那个文档 创建表也是改为insert into 总表 哪个文档ID... 读取也是 from 总表 where .... and 文档ID =   最最最烦的就是PHouse里面的这几个部分了，还有创建事务部分） 这个真的头大……是图啥呢当年写的时候要用drop 和 create来代表一个房子呢…… 一个phouse_main表和一个phouse_house表不就行了？？



## 2020.8.31

SetTimer和SetTimerEx均适配为Timerfix的`SetTimer_`和`SetTimerEx_`

(npc.inc除外)

(部分应该还是没适配的比如PRace(2020.12.27补充))

### 2020.12.27

*时间戳转日期* 

*原作者Jochemd http://forum.sa-mp.com/member.php?u=580 BUG修复:YuCarl77([R_ST]Hygen)*

*很抱歉给各位带来的影响，此BUG经研究调查后发现在12月才会出现，经过细密的排查，最终修复了该严重漏洞。*

*轻微BUG:*

  *时间戳为0时，日显示为-1 即1970-1--1 00:00:00*

  *根本原因是原作者的写法不行，干脆重写部分代码*

*严重BUG(漏洞):*

  *用户登录时将显示最后一次登录时间，在时间戳转换时于`if(day > MonthTimes[month][IsLeapYear(year)])`处导致下标越界*

*科普:*

  *unix时间戳为格林威治时间1970年01月01日00时00分00秒起至现在的总秒数*

  *格林尼治标准时间（旧译格林威治平均时间或格林威治标准时间；英语：GreenwichMeanTime，GMT）*

  *指位于英国伦敦郊区的皇家格林尼治天文台的标准时间，因为本初子午线被定义在通过那里的经线。*

*BUG出现原因*

  *原作者的疏忽，之前一直计算错的月份，month此时已为12月。数组下标0~11对应1-12月，*

  *也就是之前一直算的是1月为2月，12月为13月 超出了下标导致计算直接错误但无报错*

*排查结果:*

  *时间戳在1606780800即北京时间2020年12月1日8时0分0秒及以后时间戳100%复现此问题（HourGMT）*

  *中国时区与英国时区相差8小时，以标准返回时间加了8小时候所以是12月1日 8时后出现* 

*修复时间:*

*2020年12月26日23时27分* 

- 修复武器攻击他人扣分错误问题

- 修复信誉分显示3行BUG

- 修复啤酒瓶在大世界可以使用的问题

- 修复登录时没有移动镜头和音乐的场景



### 2021.2.10

- 尝试适配并修复`SetTimer_和SetTimerEx_`问题(npc,prace,gamemode)
- 修复部分潜在的`settimer_和settimerex_` BUG(未被反馈)
- 修复卡obj loading问题





**下一目标**

- 重写登录界面（界面全部靠一侧并到时候邮箱验证系统弄好了的话就接入找回密码系统[textdraw click]）
- 所有东西全上MYSQLR41
- 传送系统重做（上MYSQLR41 根据字段对应值判断是系统或者用户创建的）
- <u>*邮箱验证数据库列和结构优化，去掉~~验证和~~code列，废弃部分原有的写法 √*</u>
- <u>*家具系统的Owner改为UID,没有这个用户的要不删除要不归属某人要么创建用户 √*</u>
- <u>*删除或修改家具数据库的列，把是否销售issale的内容改为值,0和1代表逻辑值，可以节省存储空间 √*</u>
- ~~优化广告牌读取name方式为inner join 用户表 这样子去匹配用户的名字 省下加载广告牌一次查询两次数据库的问题~~ √
- PHouse和~~PRace的用户名列改为UID列，高度适配~~ √，没有该用户则创建账号或看着办

	- 无限爱车系统，我的爱车菜单改为选择爱车哪一辆再进入下一级的我的爱车操控。
- 写几个Actor就跟光遇一样可以在他们面前买衣服、爱车、装扮、家具、回最后一次下线的地方。
	- 下线保存玩家颜色
	- 原版三栋大楼电梯系统考虑汉化
- 适配完所有的用户名列为UID后(除PHouse基本适配),~~全部再引入外键uid~~
- *邮箱设置的时候加一个是否有人已经用了的这个提示 然后邮箱列用个unique吧 √*



**接入**

- *邮箱系统发送部分改基于用NodeJS的论坛上大佬的源码 √*

- *支持gmail和自定义邮件（我们就用自定义的smtp就好了）√*

​	*https://github.com/bruxo00/SAMPMailJS/wiki √*

**适配**

​	比赛观战信息playertext的问题 把hide改成destory show改create 然后被观察者哪边要加入set到所有观战他的人同步一样的信息（**尝试适配中** √）

**小游戏**

​	增加一些娱乐设施 比如钓鱼、摩天轮、踩玻璃、烟花系统等

**比赛结算系统**

​	上一把没结算前不能开下一把

**比赛房间系统**

​	可以浏览有哪些房间进行加入..

**实时obj创建及纹理系统**

​	用鹏达之前开过服的 **Fusez's Map Editor (Version 3)**

​	https://forum.sa-mp.com/showthread.php?t=648101

**仲裁举报系统**

​	*参考B站小黑屋和CSGO OW模式*

​	*可以加在tab栏点击玩家处*

​	*<!--第一次点击弹出几种类型的举报-->（个人信息违规、赛道记录异常等）*

​		*投票制（明显符合，不符合，弃权），采取玩家等级和时间分达到一定能力，并且具有一定场数的赛	道次数才可以成为仲裁投票者*

​	*然后48小时或者72小时自动结算，投票哪边人多就跟哪边裁定。*

​	*个人信息则弹出对话框，比赛则等接入赛道回放系统后，采用textdraw操作点击呼出菜单等。*

​	***比赛记录有问题的撤销对应赛道排名的比赛记录和个人记录**。*

​	*直接降低玩家的信誉度就行*

**封号记录**

- 改用mysql 列uid,时间戳,原因,IP

- 调用的时候就可以用select ... join users 来看名字了(匹配UID)

**好友系统**

- 查看玩家在线状态、请求传送等

---

**离线/在线消息系统...**

- 限制玩家在线时长发送

- 同时发送一次消息扣一点钱省的乱来

- 不过通过这个功能倒是可以发**系统公告**等了（**类型**）

- 这样就可以把重要的通知和更新内容发给玩家了

- 分已注册玩家和没有注册的玩家 注册完后也要去获取一遍系统公告列表然后读进来插入数据库

- 并且设置为未读

- 然后还要做**已读未读**？？？……（列名）

**- 回复**……？？？？（发送短信？）咋回复呢 对话框式的那种微信啊啥的做不出来的

**- 可通过设置开启textdraw显示与关闭。**
**- 通过设置开关接收玩家消息功能**（系统公告无法关闭）

- 点击消息系统则**按类型显示对话框**
- 以列表形式呈现用户名，uid和数量。
- 点击对应发送人进入后为列表式对话框，
- 包含标题和时间，进入后可看详细内容。
- 同样需要采用屏蔽特殊字系统。
- 用户可进行**删除**操作。

---

**比赛回放系统**

- 自动清理一个月没登录的玩家录制的npc文件
- 需要调用filemanage插件等越权操作scr目录的东西
- 同时加入npc和卸载npc需要动态增改服务器maxnpc数字限制
- 动态范围控制服务器npc人数，当然肯定是以玩家为首，所以要判断玩家总数进行调配npc数量并提示能否加载

如果这个做出来了 那就可以进阶，适配prace，实现赛道录像回放功能。
如果录像回放功能做出来了，那就可以做监管系统了（接入举报系统）

微加速可以调用瞬时速度，反作弊每指定毫秒数进行运算，通过最快提速车辆的极限值加一点点偏差值的判断，进行判定。

>通过之前的NPC不上车(LINUX平台不触发OnPlayerSpawn)可知,可以先让NPC通过延迟一点毫秒数加入(防止127.0.0.1 Blocking attack啥的提示) 然后等个一段时间后一次性全部放上车，然后审核员直接进入观战状态，NPC只进行一次（不循环，然后自动离开 或者啥反正给个下线机制）
>
>如果其他审核员也要审核这个案子然后NPC又已经在了的话 就直接切换过去审核

---

**回归奖励系统**

- 登录时自动判定距离最后一次在线时间多久，满足条件就送点金币啥的吧

---

**赛道重生**

- 加spawnpos 会更好一些（重生位置),防止在某些赛道下出现意外 √

---

**邀请和操作团队方面**

- 变量优化
- *<u>tab界面点击玩家团队 如果有团队则显示团队，没有则邀请加入团队，更方便管理√</u>*
- 如果有团队且是自己团队的人就加一个操作成员
  并且在操作时每一步都要去验证他是否还在队内，不然会误操作
- （万一对方在你操作中途退队，理论上之前已经写好了）

---

***传送请求***

- *<!--优化tpa变量名等--> 直接重写了 √* 

- *<!--tab栏加入发送tpa请求,方便玩家在人多的时候找不到ID等--> 写了 √*

***PHouse区域的textdraw考虑阉割(不启用)**  √*

---

**NPC录制系统**

- 玩家可花费指定金币进行录制NPC，并且暂存1个月
- 1个月后自动清理。
- 然后录制的文件可以给一个对话框控制加入或者T出，这样子。
- 下线自动T出加入的NPC
- 并且自动控制服务器maxnpc上限值

关于NPC的一些东西 可以去看看FCNPC的一些插件或者写法和功能 好像基于原版没法实现那么高的操作 比如说玩家重新刷车 赛道重生等 好像就很难去接管了?

https://github.com/ziggi/FCNPC









